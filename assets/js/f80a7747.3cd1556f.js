"use strict";(self.webpackChunkidentus_documentation_portal=self.webpackChunkidentus_documentation_portal||[]).push([[29937],{57955:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var t=i(74848),s=i(28453);const o={},l="Use JWT claims for agent admin access control",a={id:"decisions/2024-01-03-use-jwt-claims-for-agent-admin-auth",title:"Use JWT claims for agent admin access control",description:"- Status: accepted",source:"@site/documentation/adrs/decisions/2024-01-03-use-jwt-claims-for-agent-admin-auth.md",sourceDirName:"decisions",slug:"/decisions/2024-01-03-use-jwt-claims-for-agent-admin-auth",permalink:"/docs/adrs/decisions/2024-01-03-use-jwt-claims-for-agent-admin-auth",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"adrsSidebar",previous:{title:"JWT credential revocation status list expansion strategy",permalink:"/docs/adrs/decisions/2023-09-28-revocation-status-list-expansion-strategy"},next:{title:"Error Handling Report Problem for Agent",permalink:"/docs/adrs/decisions/2024-01-15-Error-handling-report-problem-agent"}},r={},c=[{value:"Context and Problem Statement",id:"context-and-problem-statement",level:2},{value:"Decision Drivers",id:"decision-drivers",level:2},{value:"Considered Options",id:"considered-options",level:2},{value:"Decision Outcome",id:"decision-outcome",level:2},{value:"Positive Consequences",id:"positive-consequences",level:3},{value:"Negative Consequences",id:"negative-consequences",level:3},{value:"Pros and Cons of the Options",id:"pros-and-cons-of-the-options",level:2},{value:"Option 2: Use <code>RealmRole</code> for defining roles in Keycloak",id:"option-2-use-realmrole-for-defining-roles-in-keycloak",level:3},{value:"Option 3: Use custom user attribute for defining roles in Keycloak",id:"option-3-use-custom-user-attribute-for-defining-roles-in-keycloak",level:3},{value:"Links",id:"links",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"use-jwt-claims-for-agent-admin-access-control",children:"Use JWT claims for agent admin access control"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Status: accepted"}),"\n",(0,t.jsx)(n.li,{children:"Deciders: Pat Losoponkul, Yurii Shynbuiev, David Poltorak, Shailesh Patil"}),"\n",(0,t.jsx)(n.li,{children:"Date: 2024-01-03"}),"\n",(0,t.jsx)(n.li,{children:"Tags: multitenancy, authorisation, authentication"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Technical Story: [Allow agent admin role to be authenticated by Keycloak JWT | ",(0,t.jsx)(n.a,{href:"https://input-output.atlassian.net/browse/ATL-6074",children:"https://input-output.atlassian.net/browse/ATL-6074"}),"]"]}),"\n",(0,t.jsx)(n.h2,{id:"context-and-problem-statement",children:"Context and Problem Statement"}),"\n",(0,t.jsx)(n.p,{children:"Administrators currently rely on a static API key configured in the agent.\nEmploying a static API key for administrative operations poses a security challenge for the entire system.\nA standardized centralized permission management system for administrative operations should be integrated,\nto ensure the solution is security-compliant, yet remains extensible and decoupled."}),"\n",(0,t.jsx)(n.p,{children:"The existing tenant authorization model relies on UMA (user-managed access) to protect the wallet.\nIn addition to the wallet usage, the agent also handles wallet management,\na functionality utilized by both tenants and administrators.\nWhile administrators don't directly use the wallet, they oversee its management.\nIntegrating an auth model to distinguish between admins and tenants presents a new challenge."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Where and how to define the role of admin and tenant?"}),"\n",(0,t.jsx)(n.li,{children:"What should be the authorization model for the admin role?"}),"\n",(0,t.jsx)(n.li,{children:"What boundary the admin role should be scoped to?"}),"\n",(0,t.jsx)(n.li,{children:"How to support different deployment topologies?"}),"\n",(0,t.jsx)(n.li,{children:"How does it interact with the wallet UMA model?"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"decision-drivers",children:"Decision Drivers"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Must not prevent us from using other IAM systems"}),"\n",(0,t.jsx)(n.li,{children:"Must not prevent us from supporting fine-grained tenant wallet access in the future"}),"\n",(0,t.jsx)(n.li,{children:"Should not mix admin access with tenant access"}),"\n",(0,t.jsx)(n.li,{children:"Should be easy to setup, configure and maintain"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"considered-options",children:"Considered Options"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"ClientRole"})," for defining roles in Keycloak"]}),"\n",(0,t.jsxs)(n.p,{children:["In this option, the ",(0,t.jsx)(n.code,{children:"ClientRole"})," is configured at the client level,\nand the user is mapped to the ",(0,t.jsx)(n.code,{children:"ClientRole"})," using a role mapper.\nThe role claim will be available in the JWT token at ",(0,t.jsx)(n.code,{children:"resource_access.<client_id>.roles"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"RealmRole"})," for defining roles in Keycloak"]}),"\n",(0,t.jsxs)(n.p,{children:["In this option, the ",(0,t.jsx)(n.code,{children:"RealmRole"})," is configured at the realm level,\nand the user is mapped to the ",(0,t.jsx)(n.code,{children:"RealmRole"})," using a role mapper.\nThe role claim will be available in the JWT token at ",(0,t.jsx)(n.code,{children:"realm_acces.roles"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Use custom user attribute for defining roles in Keycloak"}),"\n",(0,t.jsx)(n.p,{children:"In this option, the role is defined as a user attribute.\nThen the user attribute will be included in a token using a token mapper at any pre-configured path."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"decision-outcome",children:"Decision Outcome"}),"\n",(0,t.jsxs)(n.p,{children:["Option 1: Use ",(0,t.jsx)(n.code,{children:"ClientRole"})," for defining roles in keycloak."]}),"\n",(0,t.jsxs)(n.p,{children:["Example JWT payload containing ",(0,t.jsx)(n.code,{children:"ClientRole"}),". (Some claims are omitted for readability)"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "exp": 1704267723,\n  "aud": [\n    "cloud-agent",\n    "account"\n  ],\n  "realm_access": {\n    "roles": [\n      "default-roles-atala-demo",\n      "offline_access",\n      "uma_authorization"\n    ]\n  },\n  "resource_access": {\n    "cloud-agent": {\n      "roles": [\n        "admin"\n      ]\n    },\n    "account": {\n      "roles": [\n        "manage-account",\n        "manage-account-links",\n        "view-profile"\n      ]\n    }\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The claim is available at ",(0,t.jsx)(n.code,{children:"resource_access.<client_id>.roles"})," by default.\nThe path to the claim should be configurable by the agent to avoid vendor lock\nand remain agnostic to the IAM configuration."]}),"\n",(0,t.jsx)(n.p,{children:"After introducing the role claim, there will be two distinct access control concepts."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Wallet access scope, where the UMA resource defines specific scopes,\nproviding fine-grained access to wallet operations.\nFor instance, Alice can update a DID but not deactivate a DID on wallet#1."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Agent role, which manages agent-level permissions.\nFor example, Alice is an admin for agent #1 and can onboard new tenants,\nbut this authority doesn't extend to agent #2."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Proposed agent role authorization model"})}),"\n",(0,t.jsx)(n.p,{children:"Role is a plain text that defines what level of access a user has on a system.\nFor the agent, it needs to support 2 roles:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Admin"}),": ",(0,t.jsx)(n.code,{children:"admin"}),". Admin can never access a tenant wallet.\nAgent auth layer must ignore any UMA permission to the wallet."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Tenant"}),": ",(0,t.jsx)(n.code,{children:"tenant"})," or implicitly inferred if another role is not specified.\nTenant must have UMA permission defined to access the wallet."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"positive-consequences",children:"Positive Consequences"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Naturally align the boundary of the agent-level role per agent instance"}),"\n",(0,t.jsx)(n.li,{children:"Ready to use abstraction, minimal configuration to use and include the claim"}),"\n",(0,t.jsx)(n.li,{children:"Token can be reused across clients, enabling SSO use case"}),"\n",(0,t.jsx)(n.li,{children:"Keep the wallet access and agent-level role separated"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"negative-consequences",children:"Negative Consequences"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"ClientRole"})," is not part of the standard, other IAM systems may provide different abstraction."]}),"\n",(0,t.jsxs)(n.li,{children:["In some cases, ",(0,t.jsx)(n.code,{children:"ClientRole"})," can be redundant to configure. ",(0,t.jsx)(n.code,{children:"RealmRole"})," may be preferred in those scenarios."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"pros-and-cons-of-the-options",children:"Pros and Cons of the Options"}),"\n",(0,t.jsxs)(n.h3,{id:"option-2-use-realmrole-for-defining-roles-in-keycloak",children:["Option 2: Use ",(0,t.jsx)(n.code,{children:"RealmRole"})," for defining roles in Keycloak"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Good, because minimal effort is required to define the role and include it in the JWT"}),"\n",(0,t.jsx)(n.li,{children:"Bad, because roles are at the realm level, making it hard to support some topology"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.em,{children:"Note: This option is equally applicable as Option 1, depending on the required topology."})}),"\n",(0,t.jsx)(n.h3,{id:"option-3-use-custom-user-attribute-for-defining-roles-in-keycloak",children:"Option 3: Use custom user attribute for defining roles in Keycloak"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Bad, because role abstraction is already provided by Keycloak. Engineering effort is spent to reinvent the same concept"}),"\n",(0,t.jsx)(n.li,{children:"Bad, because it requires more effort to configure the attribute value and map it down to the token"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"links",children:"Links"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/#con-client-roles_server_administration_guide",children:"Keycloak ClientRole"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>a});var t=i(96540);const s={},o=t.createContext(s);function l(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);