"use strict";(self.webpackChunkidentus_documentation_portal=self.webpackChunkidentus_documentation_portal||[]).push([[9459],{66367:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var s=i(74848),t=i(28453);const o={},a="Use keycloak authorisation service for managing wallet permissions",r={id:"decisions/2023-09-26-use-keycloak-authorisation-service-for-managing-wallet-permissions",title:"Use keycloak authorisation service for managing wallet permissions",description:"- Status: accepted",source:"@site/documentation/adrs/decisions/2023-09-26-use-keycloak-authorisation-service-for-managing-wallet-permissions.md",sourceDirName:"decisions",slug:"/decisions/2023-09-26-use-keycloak-authorisation-service-for-managing-wallet-permissions",permalink:"/identus-docs/adrs/decisions/2023-09-26-use-keycloak-authorisation-service-for-managing-wallet-permissions",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"adrsSidebar",previous:{title:"Performance framework for the Identus platform",permalink:"/identus-docs/adrs/decisions/2023-07-14-performance-framework-for-atala-prism"},next:{title:"JWT credential revocation status list expansion strategy",permalink:"/identus-docs/adrs/decisions/2023-09-28-revocation-status-list-expansion-strategy"}},l={},c=[{value:"Context and Problem Statement",id:"context-and-problem-statement",level:2},{value:"Decision Drivers",id:"decision-drivers",level:2},{value:"Considered Options",id:"considered-options",level:2},{value:"Decision Outcome",id:"decision-outcome",level:2},{value:"On-boarding sequence diagram",id:"on-boarding-sequence-diagram",level:3},{value:"Authorisation sequence diagram",id:"authorisation-sequence-diagram",level:3},{value:"Positive Consequences",id:"positive-consequences",level:3},{value:"Negative Consequences",id:"negative-consequences",level:3},{value:"Pros and Cons of the Options",id:"pros-and-cons-of-the-options",level:2},{value:"Keycloak for authentication and associate the wallet permissions on the Agent",id:"keycloak-for-authentication-and-associate-the-wallet-permissions-on-the-agent",level:3},{value:"Keycloak for authentication and embed custom permission claims in the <code>access-token</code>",id:"keycloak-for-authentication-and-embed-custom-permission-claims-in-the-access-token",level:3},{value:"Links",id:"links",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"use-keycloak-authorisation-service-for-managing-wallet-permissions",children:"Use keycloak authorisation service for managing wallet permissions"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Status: accepted"}),"\n",(0,s.jsx)(n.li,{children:"Decider: Pat Losoponkul, Yurii Shynbuiev, David Poltorak, Milos Dzepina"}),"\n",(0,s.jsx)(n.li,{children:"Date 2023-09-26"}),"\n",(0,s.jsx)(n.li,{children:"Tags: multitenancy, authorisation, authentication"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Technical Story: [External IAM provider integration for Authentication and Authorisation Layers MVP | ",(0,s.jsx)(n.a,{href:"https://input-output.atlassian.net/browse/ATL-5149",children:"https://input-output.atlassian.net/browse/ATL-5149"}),"]"]}),"\n",(0,s.jsx)(n.h2,{id:"context-and-problem-statement",children:"Context and Problem Statement"}),"\n",(0,s.jsx)(n.p,{children:"As we move forward with multi-tenancy, it's essential to give extra attention to authentication and authorisation.\nCurrently, our authentication and authorisation processes are managed by a simple built-in IAM implementation within the Cloud Agent.\nWhile this setup is straightforward and functional, it's a somewhat basic and proprietary approach.\nTransitioning to an industry-standard IAM system like Keycloak represents an important step towards a more robust authentication and authorisation framework."}),"\n",(0,s.jsx)(n.p,{children:"Within our multi-tenant Cloud Agent, we have some key concepts:\nwallets (representing resources), entities (representing users), and authentication methods.\nThese models are integrated into our current IAM implementation within the agent allowing a loose coupling of users and resources, as well as resource access."}),"\n",(0,s.jsx)(n.p,{children:"As we consider the shift towards an external IAM system, several important questions arise:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Where to draw the boundary of AuthN/AuthZ across different components?"}),"\n",(0,s.jsx)(n.li,{children:"How to ensure smooth communication of wallet permissions across these components?"}),"\n",(0,s.jsx)(n.li,{children:"What will be the impact on the process of onboarding new users and wallets?"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These questions are essential as we explore the integration options of an external IAM  that suits our needs."}),"\n",(0,s.jsx)(n.h2,{id:"decision-drivers",children:"Decision Drivers"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Complexity to implement, operate and maintain"}),"\n",(0,s.jsx)(n.li,{children:"Must allow self-hosted option as well as future SaaS offering"}),"\n",(0,s.jsx)(n.li,{children:"Must allow flexible management of resources, users and permissions"}),"\n",(0,s.jsx)(n.li,{children:"Should adhere to standards in AuthN/AuthZ space"}),"\n",(0,s.jsx)(n.li,{children:"Should promote clear boundary between application and IAM concerns"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"considered-options",children:"Considered Options"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Keycloak for authentication and associate the wallet permissions on the Agent."}),"\n",(0,s.jsx)(n.p,{children:"In this option, the agent validates the JWT from Keycloak, extracting the payload and obtain the user identity.\nThen, the agent stores the user's associated wallet information in its database.\nKeycloak's responsibility lies solely in user authentication, as permissions management is internally managed by the agent."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Keycloak for authentication and embed custom permission claims in the ",(0,s.jsx)(n.code,{children:"access-token"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"In this option, the agent validates the JWT from Keycloak, extracting the payload containing custom claims related to the user's accessible wallets.\nWallet permissions are managed in Keycloak as user metadata, which needs to be configured to include this claim in the issued JWT."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Keycloak for authentication and authorisation service  managing permissions."}),"\n",(0,s.jsxs)(n.p,{children:["In this option, the agent handles wallet resources on Keycloak using the ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/index.html#_service_protection_api",children:"Protection API"}),".\nWallet permissions are managed through Keycloak's ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/index.html",children:"authorisation service"}),".\nWhen users intend to use the agent, it verifies wallet permissions by checking the Keycloak permission endpoint.\nSimilarly, Keycloak can also issue a self-contained JWT directly to users contains all the permission claims required by the agent."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"decision-outcome",children:"Decision Outcome"}),"\n",(0,s.jsx)(n.p,{children:"Use Keycloak authorisation service for managing wallet permissions.\nKeycloak authorisation service offers a robust abstraction based on an industry-standard specification called UMA (User-Managed Access).\nIt allows us to define resources, resource owners, permissions, and policies with ease.\nThese concepts are tried and tested, and Keycloak provides them right out of the box, making it a suitable choice.\nIt is also the only option to adhere to the standard."}),"\n",(0,s.jsx)(n.p,{children:"In this setup, applications are responsible for managing their resources and rely on\nKeycloak for managing permissions on those resources.\nTo determine whether a user can access a specific resource, the application can simply utilise Keycloak's permission endpoint."}),"\n",(0,s.jsx)(n.h3,{id:"on-boarding-sequence-diagram",children:"On-boarding sequence diagram"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    actor Admin\n    actor User\n    participant Client\n    participant CloudAgent\n    participant Keycloak\n\n    autonumber\n\n    Admin ->> CloudAgent: Create a new wallet\n    CloudAgent ->> Keycloak: Register a new resource\n    Admin ->> Keycloak: Create a new user\n    Admin ->> Keycloak: Create a new user-credential\n    Admin ->> Keycloak: Create a new permission\n    Admin ->> Keycloak: Associate permission(s) with a resource"}),"\n",(0,s.jsx)(n.h3,{id:"authorisation-sequence-diagram",children:"Authorisation sequence diagram"}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    actor Admin\n    actor User\n    participant Client\n    participant CloudAgent\n    participant Keycloak\n\n    autonumber\n\n    User ->> Client: First visit\n    Note over Client: User is not logged in\n    Client ->> Keycloak: Login with preconfigured flow\n    Keycloak ->> Client: JWT AccessToken\n    User ->> Client: Check my VC\n    Client ->> CloudAgent: Get CredentialRecord\n\n    opt Bearer token is not RPT\n      CloudAgent ->> Keycloak: Get permissions\n      Keycloak ->> CloudAgent: Permitted resource(s)\n    end\n\n    alt is permitted\n        CloudAgent ->> Client: CredentialRecord\n    else is not permitted\n        CloudAgent ->> Client: 403 Forbidden\n    end"}),"\n",(0,s.jsxs)(n.p,{children:["Optionally, users or downstream applications can directly call Keycloak permission endpoint to get a RPT (requesting-party token)\nto obtain a self-contained ",(0,s.jsx)(n.code,{children:"access-token"})," which already include permissions."]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Endpoint references"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Agent checks the user permissions using ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/22.0.0/authorization_services/#_service_obtaining_permissions",children:"permission endpoint"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"[optional] Client may also directly call this endpoint on keycloak"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Agent registers a new resource using ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/22.0.0/authorization_services/#_service_protection_resources_api",children:"resource endpoints"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/22.0.0/authorization_services/#_service_protection_whatis_obtain_pat",children:"obtain a token for the resource endpoints"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Admin manages the wallet permissions using both","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/22.0.0/authorization_services/#_service_protection_permission_api_papi",children:"Permission API"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/22.0.0/authorization_services/#_service_authorization_uma_policy_api",children:"Policy API"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"positive-consequences",children:"Positive Consequences"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Good separation between IAM and application concerns"}),"\n",(0,s.jsx)(n.li,{children:"Powerful and proven abstraction for managing permissions"}),"\n",(0,s.jsx)(n.li,{children:"Implementation is ready out of the box"}),"\n",(0,s.jsx)(n.li,{children:"Easy to migrate to different IAM vendor that supports UMA specification"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"negative-consequences",children:"Negative Consequences"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Require additional network call to obtain a permission token"}),"\n",(0,s.jsx)(n.li,{children:"Involves more moving parts in managing wallet permissions"}),"\n",(0,s.jsx)(n.li,{children:"Each IAM systems may have a slight variations to the UMA endpoints"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"pros-and-cons-of-the-options",children:"Pros and Cons of the Options"}),"\n",(0,s.jsx)(n.h3,{id:"keycloak-for-authentication-and-associate-the-wallet-permissions-on-the-agent",children:"Keycloak for authentication and associate the wallet permissions on the Agent"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Good, because permission logic is on application and allowing any IAM solution to be used regardless of authorisation feature"}),"\n",(0,s.jsx)(n.li,{children:"Bad, because permissions are managed on the application and IAM boundary is blurred"}),"\n",(0,s.jsx)(n.li,{children:"Bad, because engineering effort is spent on non-differentiating value in order to have feature parity with other authorisation system"}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"keycloak-for-authentication-and-embed-custom-permission-claims-in-the-access-token",children:["Keycloak for authentication and embed custom permission claims in the ",(0,s.jsx)(n.code,{children:"access-token"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Good, because the ",(0,s.jsx)(n.code,{children:"access-token"})," is self-contained and doesn't require extra network call"]}),"\n",(0,s.jsx)(n.li,{children:"Good, because IAM systems are more likely to support custom claims feature"}),"\n",(0,s.jsx)(n.li,{children:"Bad, because the custom claims are directly linked to user instead of resource preventing flexible mangement of permission"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"links",children:"Links"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/index.html",children:"Keycloak authorisation service"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var s=i(96540);const t={},o=s.createContext(t);function a(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);