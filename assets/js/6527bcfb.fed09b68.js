"use strict";(self.webpackChunkidentus_documentation_portal=self.webpackChunkidentus_documentation_portal||[]).push([[1068],{38525:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var s=t(74848),i=t(28453);const l={},a="Tenant Onboarding Self-Service",r={id:"multitenancy/tenant-onboarding-self-service",title:"Tenant Onboarding Self-Service",description:"In the Tenant Onboarding with External IAM tutorial,",source:"@site/cloud-agent/docs/docusaurus/multitenancy/tenant-onboarding-self-service.md",sourceDirName:"multitenancy",slug:"/multitenancy/tenant-onboarding-self-service",permalink:"/docs/tutorials/multitenancy/tenant-onboarding-self-service",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialsSidebar",previous:{title:"Tenant Onboarding with External IAM",permalink:"/docs/tutorials/multitenancy/tenant-onboarding-ext-iam"},next:{title:"Migration from apikey to JWT authentication",permalink:"/docs/tutorials/multitenancy/tenant-migration"}},o={},c=[{value:"Roles",id:"roles",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Overview",id:"overview",level:2},{value:"Endpoints",id:"endpoints",level:2},{value:"Agent endpoints",id:"agent-endpoints",level:3},{value:"Keycloak endpoints",id:"keycloak-endpoints",level:3},{value:"Tenant interactions",id:"tenant-interactions",level:2},{value:"1. Self-register account on Keycloak",id:"1-self-register-account-on-keycloak",level:3},{value:"2. Obtain access token from Keycloak",id:"2-obtain-access-token-from-keycloak",level:3},{value:"3. Check the existing wallets",id:"3-check-the-existing-wallets",level:3},{value:"4. Create a new wallet",id:"4-create-a-new-wallet",level:3},{value:"5. Perform a simple action to verify access to the Cloud Agent",id:"5-perform-a-simple-action-to-verify-access-to-the-cloud-agent",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"tenant-onboarding-self-service",children:"Tenant Onboarding Self-Service"}),"\n",(0,s.jsxs)(n.p,{children:["In the ",(0,s.jsx)(n.a,{href:"/docs/tutorials/multitenancy/tenant-onboarding-ext-iam",children:"Tenant Onboarding with External IAM"})," tutorial,\nwe learned how ",(0,s.jsx)(n.a,{href:"/docs/concepts/glossary#keycloak-service",children:"Keycloak"})," helps with user access and how it works together with the agent.\nTo set things up, the admin has to provision the required resources.\nHowever, relying on the admin for onboarding operations can be restrictive for some use cases.\nFor example, some tenants might want to onboard on a self-service agent instance without admin intervention."]}),"\n",(0,s.jsxs)(n.p,{children:["By leveraging Keycloak for a self-service agent instance,\nusers can self-register or link to other ",(0,s.jsx)(n.a,{href:"/docs/concepts/glossary#idp",children:"Identity Providers (IDPs)"})," to register an account.\nOnce the account is registered, users can use it to set up their wallets.\nThis tutorial will investigate the steps to facilitate this scenario where ",(0,s.jsx)(n.a,{href:"/docs/concepts/glossary#administrator",children:"administrator"})," intervention is unnecessary."]}),"\n",(0,s.jsx)(n.h2,{id:"roles",children:"Roles"}),"\n",(0,s.jsx)(n.p,{children:"In self-service tenant management with external IAM, there is only one role:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/docs/concepts/glossary#tenant",children:"Tenant"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Keycloak is up and running."}),"\n",(0,s.jsxs)(n.li,{children:["Keycloak is configured as follows","\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["A realm called ",(0,s.jsx)(n.code,{children:"my-realm"})," is created"]}),"\n",(0,s.jsxs)(n.li,{children:["A client called ",(0,s.jsx)(n.code,{children:"cloud-agent"})," under ",(0,s.jsx)(n.code,{children:"my-realm"})," with ",(0,s.jsx)(n.strong,{children:"authorization"})," feature is created. (See ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/authorization_services/index.html#_resource_server_create_client",children:"create client instruction"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Make sure the ",(0,s.jsx)(n.code,{children:"cloud-agent"})," client has ",(0,s.jsx)(n.strong,{children:"direct access grants"})," enabled to simplify the login process for this tutorial."]}),"\n",(0,s.jsxs)(n.li,{children:["Make sure to ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/index.html#con-user-registration_server_administration_guide",children:"allow user self-registration"}),"."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.li,{children:"The Cloud Agent is up and running"}),"\n",(0,s.jsxs)(n.li,{children:["The Cloud Agent is configured with the following environment variables:","\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"ADMIN_TOKEN=my-admin-token"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"DEFAULT_WALLET_ENABLED=false"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"KEYCLOAK_ENABLED=true"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"KEYCLOAK_URL=http://localhost:9980"})," (replace with appropriate value)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"KEYCLOAK_REALM=my-realm"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"KEYCLOAK_CLIENT_ID=cloud-agent"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"KEYCLOAK_CLIENT_SECRET=<KEYCLOAK_CLIENT_SECRET>"})," (replace with appropriate value)"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"KEYCLOAK_UMA_AUTO_UPGRADE_RPT=true"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"This tutorial demonstrate the process of user self-registration on Keycloak.\nThen, the users can log in to Keycloak to obtain a token.\nWhen the agent uses this token for the wallet creation, the agent recognizes it belongs to a tenant and automatically associates the tenant's permission with the created wallet."}),"\n",(0,s.jsx)(n.h2,{id:"endpoints",children:"Endpoints"}),"\n",(0,s.jsx)(n.h3,{id:"agent-endpoints",children:"Agent endpoints"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Endpoint"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Role"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /wallets"})}),(0,s.jsx)(n.td,{children:"List the wallets on the Cloud Agent"}),(0,s.jsx)(n.td,{children:"Tenant"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"POST /wallets"})}),(0,s.jsx)(n.td,{children:"Create a new wallet on the Cloud Agent"}),(0,s.jsx)(n.td,{children:"Tenant"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"GET /did-registrar/dids"})}),(0,s.jsx)(n.td,{children:"List the DIDs inside the wallet"}),(0,s.jsx)(n.td,{children:"Tenant"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"keycloak-endpoints",children:"Keycloak endpoints"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Endpoint"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Role"})]})}),(0,s.jsx)(n.tbody,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"POST /realms/{realm}/protocol/openid-connect/token"})}),(0,s.jsx)(n.td,{children:"Issue a new JWT token"}),(0,s.jsx)(n.td,{children:"Tenant"})]})})]}),"\n",(0,s.jsx)(n.h2,{id:"tenant-interactions",children:"Tenant interactions"}),"\n",(0,s.jsx)(n.h3,{id:"1-self-register-account-on-keycloak",children:"1. Self-register account on Keycloak"}),"\n",(0,s.jsxs)(n.p,{children:["Start by registering a new account on Keycloak, accessible through its login page.\nUsually, this should be available at ",(0,s.jsx)(n.code,{children:"http://localhost:9980/realms/my-realm/account/"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For detailed instructions on how to register a new user,\nplease refer to ",(0,s.jsx)(n.a,{href:"https://www.keycloak.org/docs/latest/server_admin/index.html#proc-registering-new-user_server_administration_guide",children:"registering a new user"})," section on the official documentation."]}),"\n",(0,s.jsx)(n.h3,{id:"2-obtain-access-token-from-keycloak",children:"2. Obtain access token from Keycloak"}),"\n",(0,s.jsx)(n.p,{children:"Once a new account is registered, Keycloak should recognize it, allowing the user to log in and obtain the access token."}),"\n",(0,s.jsx)(n.p,{children:"Run this command to log in and get the access token."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X \'POST\' \\\n  \'http://localhost:9980/realms/my-realm/protocol/openid-connect/token\' \\\n  -d "grant_type=password" \\\n  -d "client_id=admin-cli" \\\n  -d "username=alice" \\\n  -d "password=1234"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Make sure to use the correct username and password.\nSpecial attention on the ",(0,s.jsx)(n.code,{children:"client_id"}),"; this should be the actual ",(0,s.jsx)(n.code,{children:"client_id"})," of the frontend application that logs the user in.\nFor this tutorial, it is OK to use ",(0,s.jsx)(n.code,{children:"admin-cli"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Example token response (some fields omitted for readability)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "access_token": "eyJhbGciOi...7ocDHofUDQ",\n    "refresh_token": "eyJhbGciOi...otsEEi4eQA",\n    ...\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"3-check-the-existing-wallets",children:"3. Check the existing wallets"}),"\n",(0,s.jsx)(n.p,{children:"Right after the account is registered, no permission should be associated with it.\nListing wallets on it should return empty results."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -X 'GET' \\\n  'http://localhost:8080/cloud-agent/wallets' \\\n  -H 'Authorization: Bearer eyJhbGciOi...7ocDHofUDQ' \\\n  -H 'Accept: application/json'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Use the correct ",(0,s.jsx)(n.code,{children:"access_token"})," in the previous command's Authorization header."]}),"\n",(0,s.jsx)(n.p,{children:"Response Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "self": "/wallets",\n  "kind": "WalletPage",\n  "pageOf": "/wallets",\n  "contents": []\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"4-create-a-new-wallet",children:"4. Create a new wallet"}),"\n",(0,s.jsxs)(n.p,{children:["Create a wallet using a ",(0,s.jsx)(n.code,{children:"POST /wallets"})," endpoint.\nThis wallet will be a container for the tenant's assets (DIDs, VCs, Connections, etc.).\nThe Agent can provide or randomly generate the wallet seed during wallet creation."]}),"\n",(0,s.jsx)(n.p,{children:"If the user already has the wallet associated, the wallet creation will fail as multiple wallets per tenant are not yet allowed."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -X 'POST' \\\n  'http://localhost:8080/cloud-agent/wallets' \\\n  -H 'Authorization: Bearer eyJhbGciOi...7ocDHofUDQ' \\\n  -H 'Accept: application/json' \\\n  -H 'Content-Type: application/json' \\\n  -d '{\n    \"seed\": \"c9994785ce6d548134020f610b76102ca1075d3bb672a75ec8c9a27a7b8607e3b9b384e43b77bb08f8d5159651ae38b98573f7ecc79f2d7e1f1cc371ce60cf8a\",\n    \"name\": \"my-wallet\"\n  }'\n"})}),"\n",(0,s.jsx)(n.p,{children:"Response Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "id": "99734c87-5c9d-4697-b5fd-dea4e9590ba7",\n  "name": "my-wallet",\n  "createdAt": "2023-01-01T00:00:00Z",\n  "updatedAt": "2023-01-01T00:00:00Z"\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"In this step, the agent creates both wallet resource and UMA permission on Keycloak, assigning the new wallet to the user who created it."}),"\n",(0,s.jsx)(n.h3,{id:"5-perform-a-simple-action-to-verify-access-to-the-cloud-agent",children:"5. Perform a simple action to verify access to the Cloud Agent"}),"\n",(0,s.jsxs)(n.p,{children:["Without further operation, the wallet should be available for the tenant.\nTo prove that the tenant can access the wallet, list the DIDs using RPT in the ",(0,s.jsx)(n.code,{children:"Authorization"})," header."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl --location --request GET 'http://localhost:8080/cloud-agent/did-registrar/dids' \\\n  -H 'Authorization: Bearer eyJhbGciOi...7ocDHofUDQ' \\\n  -H 'Accept: application/json'\n"})}),"\n",(0,s.jsx)(n.p,{children:"The wallet was successfully created, but it currently does not contain any DIDs - indicated by an empty list and a 200 status.\nThe tenant should only perform interactions within the scope of this wallet."})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var s=t(96540);const i={},l=s.createContext(i);function a(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);